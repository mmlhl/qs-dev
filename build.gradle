plugins {
    id 'java'
    id 'application'
    id 'idea'
}

group = 'me.mm.qs'
version = '1.0-SNAPSHOT'

sourceSets {
    main {
        java {
            srcDirs = [
                'src/main/java', 
                'scripts'
            ]
        }
    }
}

// é…ç½®Javaç¼–è¯‘å™¨å…è®¸éé™æ€è®¿é—®å·¥å…·æ–¹æ³•
compileJava {
    options.encoding = 'UTF-8'
    options.compilerArgs += ['-Xlint:none']
    // å°†å·¥å…·ç±»æ·»åŠ åˆ°ç¼–è¯‘ç±»è·¯å¾„,ä½¿Main.javaå¯ä»¥å¼•ç”¨å®ƒä»¬
    doFirst {
        // ç¡®ä¿å·¥å…·ç±»é¦–å…ˆè¢«ç¼–è¯‘
        def utilsFiles = fileTree(dir: 'src/main/java/me/mm/qs/myscript/utils', include: '*.java')
        if (utilsFiles.files) {
            println "å·¥å…·ç±»å°†ä¼˜å…ˆç¼–è¯‘"
        }
    }
}

repositories {
    mavenCentral()
}

dependencies {
    implementation files('lib/android.jar')
    implementation 'com.github.javaparser:javaparser-core:3.25.0'
    testImplementation platform('org.junit:junit-bom:5.10.0')
    testImplementation 'org.junit.jupiter:junit-jupiter'
}

test {
    useJUnitPlatform()
}

application {
    mainClass = 'JavaToBeanShellConverter'
}

// å°†MyScript.javaè½¬æ¢ä¸ºBeanShellçš„ä»»åŠ¡
task convertScript(type: JavaExec) {
    group = 'build'
    description = 'å°†myscriptåŒ…è½¬æ¢ä¸ºBeanShellæ ¼å¼(è¾“å‡ºåˆ°dist/)'
    classpath = sourceSets.main.runtimeClasspath
    mainClass = 'JavaToBeanShellConverter'
    args 'src/main/java/me/mm/qs/myscript'
    
    // ä¿®å¤æ§åˆ¶å°è¾“å‡ºä¸­æ–‡å­—ç¬¦çš„ç¼–ç é—®é¢˜
    systemProperty 'file.encoding', 'UTF-8'
    systemProperty 'sun.stdout.encoding', 'UTF-8'
    systemProperty 'sun.stderr.encoding', 'UTF-8'
}

// åœ¨compileJavaä¹‹åè‡ªåŠ¨è½¬æ¢
compileJava.finalizedBy convertScript

// ========================================
// éƒ¨ç½²è„šæœ¬åˆ°Androidè®¾å¤‡
// ========================================
// ä½¿ç”¨æ–¹æ³•:
//   1. é€šè¿‡USBè¿æ¥Androidè®¾å¤‡
//   2. å¯ç”¨USBè°ƒè¯•
//   3. è¿è¡Œ: gradlew deployScript
//
// è‡ªåŠ¨éƒ¨ç½²: å–æ¶ˆæ³¨é‡Šæœ€åä¸€è¡Œä»¥å¯ç”¨æ¯æ¬¡æ„å»ºåè‡ªåŠ¨éƒ¨ç½²
// ========================================

// é€šè¿‡ADBå°†è„šæœ¬éƒ¨ç½²åˆ°Androidè®¾å¤‡çš„ä»»åŠ¡
task deployScript(type: Exec) {
    group = 'deploy'
    description = 'é€šè¿‡ADBå°†è„šæœ¬éƒ¨ç½²åˆ°Androidè®¾å¤‡'
    
    dependsOn convertScript
    
    doFirst {
        // è¾…åŠ©å‡½æ•°:è·å–è„šæœ¬åç§°
        def getScriptName = {
            def distDir = new File(project.projectDir, 'dist')
            def scriptDirs = distDir.listFiles({ File f -> f.isDirectory() && !f.name.startsWith('.') } as FileFilter)
            if (scriptDirs && scriptDirs.length > 0) {
                return scriptDirs[0].name
            }
            throw new GradleException('åœ¨dist/ç›®å½•ä¸­æœªæ‰¾åˆ°è„šæœ¬æ–‡ä»¶å¤¹')
        }
        
        // è¾…åŠ©å‡½æ•°:æ£€æŸ¥ADB
        def checkADB = {
            def adbCheck = new ByteArrayOutputStream()
            project.exec {
                commandLine 'adb', 'devices'
                standardOutput = adbCheck
                errorOutput = new ByteArrayOutputStream()
                ignoreExitValue = true
            }
            
            def devicesList = adbCheck.toString().trim()
            if (!devicesList.contains('device') || devicesList.split('\n').size() < 2) {
                println "\nâš ï¸  æœªæ£€æµ‹åˆ°Androidè®¾å¤‡!"
                println "è¯·è¿æ¥æ‚¨çš„è®¾å¤‡å¹¶å¯ç”¨USBè°ƒè¯•ã€‚"
                throw new StopExecutionException()
            }
        }
        
        try {
            checkADB()
        } catch (Exception e) {
            println "\nâš ï¸  æœªæ‰¾åˆ°ADBæˆ–è®¾å¤‡æœªè¿æ¥!"
            throw new StopExecutionException()
        }
        
        def scriptName = getScriptName()
        def scriptDir = new File(project.projectDir, "dist/${scriptName}")
        def targetPath = "/storage/emulated/0/Android/data/com.tencent.mobileqq/QStory/Plugin/${scriptName}"
        
        println "\nğŸ“± æ­£åœ¨éƒ¨ç½²è„šæœ¬: ${scriptName}"
        println "åˆ›å»ºç›®å½•: ${targetPath}"
        
        project.exec {
            commandLine 'adb', 'shell', 'mkdir', '-p', targetPath
            ignoreExitValue = true
        }
        
        // å°†dist/scriptNameä¸­çš„æ‰€æœ‰æ–‡ä»¶æ¨é€åˆ°ç›®æ ‡ç›®å½•
        println "\næ¨é€æ–‡ä»¶:"
        fileTree(dir: scriptDir, include: '**/*').each { file ->
            if (file.isFile()) {
                def relativePath = scriptDir.toPath().relativize(file.toPath()).toString().replace('\\', '/')
                def targetFile = "${targetPath}/${relativePath}"
                
                println "  âœ“ ${relativePath}"
                project.exec {
                    commandLine 'adb', 'push', file.absolutePath, targetFile
                    standardOutput = new ByteArrayOutputStream()
                    errorOutput = new ByteArrayOutputStream()
                }
            }
        }
        
        // åˆ›å»ºå¹¶æ¨é€ç©ºçš„error.txt
        def emptyErrorFile = new File(project.projectDir, 'build/tmp/error.txt')
        emptyErrorFile.parentFile.mkdirs()
        emptyErrorFile.text = ''
        println "  âœ“ error.txt (ç©ºæ–‡ä»¶)"
        project.exec {
            commandLine 'adb', 'push', emptyErrorFile.absolutePath, "${targetPath}/error.txt"
            standardOutput = new ByteArrayOutputStream()
            errorOutput = new ByteArrayOutputStream()
        }
        
        println "\nâœ… éƒ¨ç½²æˆåŠŸå®Œæˆ!"
        println "ğŸ“‚ è„šæœ¬å·²éƒ¨ç½²åˆ°: ${targetPath}"
    }
    
    commandLine 'cmd', '/c', 'echo.'
}


// å¯é€‰: è½¬æ¢æˆåŠŸåè‡ªåŠ¨éƒ¨ç½²(ä¸éœ€è¦æ—¶æ³¨é‡Šæ‰)
convertScript.finalizedBy deployScript

// ä»Androidè®¾å¤‡è·å–error.txtçš„ä»»åŠ¡
task fetchError(type: Exec) {
    group = 'deploy'
    description = 'ä»Androidè®¾å¤‡è·å–error.txtç”¨äºåˆ†æ'
    
    doFirst {
        // å¤ç”¨è¾…åŠ©å‡½æ•°
        def getScriptName = {
            def distDir = new File(project.projectDir, 'dist')
            def scriptDirs = distDir.listFiles({ File f -> f.isDirectory() && !f.name.startsWith('.') } as FileFilter)
            if (scriptDirs && scriptDirs.length > 0) {
                return scriptDirs[0].name
            }
            throw new GradleException('åœ¨dist/ç›®å½•ä¸­æœªæ‰¾åˆ°è„šæœ¬æ–‡ä»¶å¤¹')
        }
        
        def checkADB = {
            def adbCheck = new ByteArrayOutputStream()
            project.exec {
                commandLine 'adb', 'devices'
                standardOutput = adbCheck
                errorOutput = new ByteArrayOutputStream()
                ignoreExitValue = true
            }
            
            def devicesList = adbCheck.toString().trim()
            if (!devicesList.contains('device') || devicesList.split('\n').size() < 2) {
                println "\nâš ï¸  No Android device detected!"
                println "Please connect your device and enable USB debugging."
                throw new StopExecutionException()
            }
        }
        
        try {
            checkADB()
        } catch (Exception e) {
            println "\nâš ï¸  ADB not found or device not connected!"
            throw new StopExecutionException()
        }
        
        def scriptName = getScriptName()
        def sourcePath = "/storage/emulated/0/Android/data/com.tencent.mobileqq/QStory/Plugin/${scriptName}/error.txt"
        def targetFile = new File(project.projectDir, 'error.txt')
        
        println "\nğŸ“¥ æ­£åœ¨è·å–error.txtä»: ${scriptName}"
        println "æºè·¯å¾„: ${sourcePath}"
        
        def pullExec = project.exec {
            commandLine 'adb', 'pull', sourcePath, targetFile.absolutePath
            standardOutput = new ByteArrayOutputStream()
            errorOutput = new ByteArrayOutputStream()
            ignoreExitValue = true
        }
        
        if (pullExec.exitValue == 0) {
            println "âœ… é”™è¯¯æ–‡ä»¶è·å–æˆåŠŸ!"
            println "ğŸ“‚ ä¿å­˜åˆ°: ${targetFile.absolutePath}"
            
            if (targetFile.exists() && targetFile.length() > 0) {
                println "\nğŸ“„ é”™è¯¯æ–‡ä»¶å†…å®¹:"
                println "=" * 60
                println targetFile.text
                println "=" * 60
            } else {
                println "\nâœ“ æœªå‘ç°é”™è¯¯(æ–‡ä»¶ä¸ºç©º)"
            }
        } else {
            println "\nâš ï¸  è®¾å¤‡ä¸Šæœªæ‰¾åˆ°é”™è¯¯æ–‡ä»¶(è„šæœ¬å¯èƒ½æ²¡æœ‰é”™è¯¯)"
        }
    }
    
    commandLine 'cmd', '/c', 'echo.'
}