plugins {
    id 'java'
    id 'application'
    id 'idea'
}

group = 'me.mm.qs'
version = '1.0-SNAPSHOT'

sourceSets {
    main {
        java {
            srcDirs = [
                'src/main/java', 
                'scripts'
            ]
        }
    }
}

// é…ç½®Javaç¼–è¯‘å™¨
compileJava {
    options.encoding = 'UTF-8'
    options.compilerArgs += ['-Xlint:none']
}

repositories {
    mavenCentral()
}

dependencies {
    implementation files('lib/android.jar')
    implementation 'com.github.javaparser:javaparser-core:3.25.0'
    testImplementation platform('org.junit:junit-bom:5.10.0')
    testImplementation 'org.junit.jupiter:junit-jupiter'
}

test {
    useJUnitPlatform()
}

application {
    mainClass = 'JavaToBeanShellConverter'
}

// ========================================
// è„šæœ¬è½¬æ¢ä»»åŠ¡
// ========================================
// ç”¨æ³•: 
//   gradlew convertScript -PscriptName=voice_converter  (è½¬æ¢æŒ‡å®šè„šæœ¬)
//   gradlew convertScript                                (è½¬æ¢æ‰€æœ‰è„šæœ¬)
// ========================================
task convertScript(type: JavaExec) {
    group = 'script'
    description = 'å°†scriptsåŒ…ä¸­çš„è„šæœ¬è½¬æ¢ä¸ºBeanShellæ ¼å¼(è¾“å‡ºåˆ°dist/)'
    classpath = sourceSets.main.runtimeClasspath
    mainClass = 'JavaToBeanShellConverter'
    
    doFirst {
        // æ¸…ç©ºæ—§çš„æ˜ å°„æ–‡ä»¶
        def mappingFile = file('dist/.script-mapping')
        if (mappingFile.exists()) {
            mappingFile.delete()
        }
        
        def scriptName = project.findProperty('scriptName')
        def scriptsDir = file('src/main/java/me/mm/qs/scripts')
        
        if (scriptName) {
            // è½¬æ¢æŒ‡å®šè„šæœ¬
            def scriptDir = new File(scriptsDir, scriptName)
            if (!scriptDir.exists()) {
                throw new GradleException("è„šæœ¬ä¸å­˜åœ¨: ${scriptName}\nå¯ç”¨è„šæœ¬: ${scriptsDir.listFiles()?.findAll{it.isDirectory()}*.name?.join(', ')}")
            }
            args scriptDir.absolutePath
            println "\nğŸ“¦ è½¬æ¢è„šæœ¬: ${scriptName}"
        } else {
            // è½¬æ¢æ‰€æœ‰è„šæœ¬
            println "\nğŸ“¦ è½¬æ¢æ‰€æœ‰è„šæœ¬..."
            scriptsDir.listFiles()?.findAll { it.isDirectory() }?.each { dir ->
                println "  - ${dir.name}"
            }
            args scriptsDir.absolutePath, '--all'
        }
    }
    
    // ä¿®å¤æ§åˆ¶å°è¾“å‡ºä¸­æ–‡å­—ç¬¦çš„ç¼–ç é—®é¢˜
    systemProperty 'file.encoding', 'UTF-8'
    systemProperty 'sun.stdout.encoding', 'UTF-8'
    systemProperty 'sun.stderr.encoding', 'UTF-8'
}

// ========================================
// éƒ¨ç½²è„šæœ¬åˆ°Androidè®¾å¤‡
// ========================================
// ç”¨æ³•:
//   gradlew deployScript -PscriptName=voice_converter              (éƒ¨ç½²æŒ‡å®šè„šæœ¬)
//   gradlew deployScript -PscriptName=voice_converter -PdeviceId=xxx  (éƒ¨ç½²åˆ°æŒ‡å®šè®¾å¤‡)
//   gradlew runScript -PscriptName=voice_converter                  (è½¬æ¢+éƒ¨ç½²)
// ========================================

// åˆ—å‡ºæ‰€æœ‰è¿æ¥çš„è®¾å¤‡
task listDevices {
    group = 'script'
    description = 'åˆ—å‡ºæ‰€æœ‰è¿æ¥çš„Androidè®¾å¤‡'
    
    doLast {
        def adbOutput = new ByteArrayOutputStream()
        exec {
            commandLine 'adb', 'devices', '-l'
            standardOutput = adbOutput
            errorOutput = new ByteArrayOutputStream()
            ignoreExitValue = true
        }
        
        def output = adbOutput.toString().trim()
        def lines = output.split('\n')
        
        println "\nğŸ“± å·²è¿æ¥è®¾å¤‡:"
        println "=" * 60
        
        def deviceCount = 0
        lines.each { line ->
            if (line.contains('device') && !line.startsWith('List')) {
                deviceCount++
                def parts = line.split('\\s+')
                def deviceId = parts[0]
                def model = ''
                def modelMatch = line =~ /model:(\S+)/
                if (modelMatch) {
                    model = modelMatch[0][1]
                }
                println "  ${deviceCount}. ${deviceId}  ${model}"
            }
        }
        
        if (deviceCount == 0) {
            println "  æ— è®¾å¤‡è¿æ¥"
        }
        
        println "=" * 60
        println "\nä½¿ç”¨æ–¹æ³•:"
        println "  gradlew runScript -PscriptName=xxx -PdeviceId=<è®¾å¤‡ID>"
    }
}

// é€šè¿‡ADBå°†è„šæœ¬éƒ¨ç½²åˆ°Androidè®¾å¤‡çš„ä»»åŠ¡
task deployScript(type: Exec) {
    group = 'script'
    description = 'é€šè¿‡ADBå°†æŒ‡å®šè„šæœ¬éƒ¨ç½²åˆ°Androidè®¾å¤‡'
    
    dependsOn convertScript
    
    doFirst {
        def deviceId = project.findProperty('deviceId')
        def inputScriptName = project.findProperty('scriptName')
        
        // è¯»å–æ˜ å°„æ–‡ä»¶è·å–æ˜¾ç¤ºåç§°
        def getDisplayName = { String srcName ->
            def mappingFile = file('dist/.script-mapping')
            if (mappingFile.exists()) {
                def mappings = [:]
                mappingFile.text.split('\n').each { line ->
                    if (line.contains('=')) {
                        def parts = line.split('=')
                        mappings[parts[0].trim()] = parts[1].trim()
                    }
                }
                if (mappings.containsKey(srcName)) {
                    return mappings[srcName]
                }
            }
            return srcName
        }
        
        // è·å–è¦éƒ¨ç½²çš„è„šæœ¬åç§°ï¼ˆæ˜¾ç¤ºåç§°ï¼Œå³ dist ä¸­çš„ç›®å½•åï¼‰
        def getScriptName = {
            if (inputScriptName) {
                // å°†æºç›®å½•åè½¬æ¢ä¸ºæ˜¾ç¤ºåç§°
                return getDisplayName(inputScriptName)
            }
            // å¦‚æœæ²¡æŒ‡å®šï¼ŒæŸ¥æ‰¾ dist ç›®å½•ä¸‹çš„è„šæœ¬
            def distDir = new File(project.projectDir, 'dist')
            def scriptDirs = distDir.listFiles({ File f -> f.isDirectory() && !f.name.startsWith('.') } as FileFilter)
            if (scriptDirs && scriptDirs.length > 0) {
                if (scriptDirs.length > 1) {
                    println "\nâš ï¸  å‘ç°å¤šä¸ªè„šæœ¬ï¼Œè¯·ä½¿ç”¨ -PscriptName=xxx æŒ‡å®š"
                    println "å¯ç”¨è„šæœ¬: ${scriptDirs*.name.join(', ')}"
                    throw new StopExecutionException()
                }
                return scriptDirs[0].name
            }
            throw new GradleException('åœ¨dist/ç›®å½•ä¸­æœªæ‰¾åˆ°è„šæœ¬æ–‡ä»¶å¤¹')
        }
        
        // è¾…åŠ©å‡½æ•°:æ£€æŸ¥ADBå¹¶è·å–è®¾å¤‡åˆ—è¡¨
        def getDevices = {
            def adbCheck = new ByteArrayOutputStream()
            project.exec {
                commandLine 'adb', 'devices'
                standardOutput = adbCheck
                errorOutput = new ByteArrayOutputStream()
                ignoreExitValue = true
            }
            
            def devicesList = adbCheck.toString().trim()
            def devices = []
            devicesList.split('\n').each { line ->
                if (line.contains('device') && !line.startsWith('List')) {
                    devices << line.split('\\s+')[0]
                }
            }
            return devices
        }
        
        def devices = getDevices()
        if (devices.isEmpty()) {
            println "\nâš ï¸  æœªæ£€æµ‹åˆ°Androidè®¾å¤‡!"
            println "è¯·è¿æ¥æ‚¨çš„è®¾å¤‡å¹¶å¯ç”¨USBè°ƒè¯•ã€‚"
            throw new StopExecutionException()
        }
        
        // å¦‚æœæœ‰å¤šä¸ªè®¾å¤‡ä¸”æœªæŒ‡å®šï¼Œæç¤ºç”¨æˆ·
        if (devices.size() > 1 && !deviceId) {
            println "\nâš ï¸  å‘ç°å¤šä¸ªè®¾å¤‡ï¼Œè¯·ä½¿ç”¨ -PdeviceId=xxx æŒ‡å®š"
            println "å¯ç”¨è®¾å¤‡: ${devices.join(', ')}"
            throw new StopExecutionException()
        }
        
        def targetDevice = deviceId ?: devices[0]
        def adbCmd = { List<String> args ->
            def cmd = ['adb', '-s', targetDevice] + args
            project.exec {
                commandLine cmd
                standardOutput = new ByteArrayOutputStream()
                errorOutput = new ByteArrayOutputStream()
                ignoreExitValue = true
            }
        }
        
        def scriptName = getScriptName()
        def scriptDir = new File(project.projectDir, "dist/${scriptName}")
        def targetPath = "/storage/emulated/0/Android/data/com.tencent.mobileqq/QStory/Plugin/${scriptName}"
        
        println "\nğŸ“± æ­£åœ¨éƒ¨ç½²è„šæœ¬: ${scriptName}"
        println "ç›®æ ‡è®¾å¤‡: ${targetDevice}"
        println "åˆ›å»ºç›®å½•: ${targetPath}"
        
        project.exec {
            commandLine 'adb', '-s', targetDevice, 'shell', 'mkdir', '-p', targetPath
            ignoreExitValue = true
        }
        
        // å°†dist/scriptNameä¸­çš„æ‰€æœ‰æ–‡ä»¶æ¨é€åˆ°ç›®æ ‡ç›®å½•
        println "\næ¨é€æ–‡ä»¶:"
        fileTree(dir: scriptDir, include: '**/*').each { file ->
            if (file.isFile()) {
                def relativePath = scriptDir.toPath().relativize(file.toPath()).toString().replace('\\', '/')
                def targetFile = "${targetPath}/${relativePath}"
                
                println "  âœ“ ${relativePath}"
                project.exec {
                    commandLine 'adb', '-s', targetDevice, 'push', file.absolutePath, targetFile
                    standardOutput = new ByteArrayOutputStream()
                    errorOutput = new ByteArrayOutputStream()
                }
            }
        }
        
        // åˆ›å»ºå¹¶æ¨é€ç©ºçš„error.txt
        def emptyErrorFile = new File(project.projectDir, 'build/tmp/error.txt')
        emptyErrorFile.parentFile.mkdirs()
        emptyErrorFile.text = ''
        println "  âœ“ error.txt (ç©ºæ–‡ä»¶)"
        project.exec {
            commandLine 'adb', '-s', targetDevice, 'push', emptyErrorFile.absolutePath, "${targetPath}/error.txt"
            standardOutput = new ByteArrayOutputStream()
            errorOutput = new ByteArrayOutputStream()
        }
        
        println "\nâœ… éƒ¨ç½²æˆåŠŸå®Œæˆ!"
        println "ğŸ“‚ è„šæœ¬å·²éƒ¨ç½²åˆ°: ${targetPath}"
    }
    
    commandLine 'cmd', '/c', 'echo.'
}

// è½¬æ¢å¹¶éƒ¨ç½²è„šæœ¬ï¼ˆå¿«æ·å‘½ä»¤ï¼‰
// ç”¨æ³•: gradlew runScript -PscriptName=voice_converter [-PdeviceId=xxx]
task runScript {
    group = 'script'
    description = 'è½¬æ¢å¹¶éƒ¨ç½²è„šæœ¬ï¼ˆå¿«æ·å‘½ä»¤ï¼‰'
    dependsOn deployScript
}

// ========================================
// è„šæœ¬ç®¡ç†ä»»åŠ¡
// ========================================

// åˆ—å‡ºæ‰€æœ‰å¯ç”¨è„šæœ¬
task listScripts {
    group = 'script'
    description = 'åˆ—å‡ºæ‰€æœ‰å¯ç”¨è„šæœ¬'
    
    doLast {
        def scriptsDir = file('src/main/java/me/mm/qs/scripts')
        def scripts = scriptsDir.listFiles()?.findAll { it.isDirectory() }
        
        println "\nğŸ“š å¯ç”¨è„šæœ¬:"
        println "=" * 40
        scripts?.each { dir ->
            def mainFile = new File(dir, 'Main.java')
            if (mainFile.exists()) {
                // è¯•å›¾è¯»å–è„šæœ¬åç§°
                def content = mainFile.text
                def nameMatch = content =~ /name\s*=\s*"([^"]+)"/
                def displayName = nameMatch ? nameMatch[0][1] : dir.name
                println "  â€¢ ${dir.name} -> ${displayName}"
            } else {
                println "  â€¢ ${dir.name} (æ— Main.java)"
            }
        }
        println "=" * 40
        println "\nä½¿ç”¨æ–¹æ³•:"
        println "  gradlew listDevices                             åˆ—å‡ºè®¾å¤‡"
        println "  gradlew runScript -PscriptName=<åç§°>           è½¬æ¢+éƒ¨ç½²"
        println "  gradlew convertScript -PscriptName=<åç§°>       ä»…è½¬æ¢"
        println "  gradlew deployScript -PscriptName=<åç§°>        ä»…éƒ¨ç½²"
        println "  gradlew fetchError -PscriptName=<åç§°>          è·å–é”™è¯¯"
        println "  gradlew createScript -PscriptName=<åç§°>        åˆ›å»ºæ–°è„šæœ¬"
        println "\nè®¾å¤‡é€‰æ‹©: æ·»åŠ  -PdeviceId=xxx å¯æŒ‡å®šç›®æ ‡è®¾å¤‡"
    }
}

// åˆ›å»ºæ–°è„šæœ¬
// ç”¨æ³•: gradlew createScript -PscriptName=my_new_script -PdisplayName="æˆ‘çš„æ–°è„šæœ¬"
task createScript {
    group = 'script'
    description = 'åˆ›å»ºæ–°è„šæœ¬(ä»æ¨¡æ¿å¤åˆ¶)'
    
    doLast {
        def scriptName = project.findProperty('scriptName')
        def displayName = project.findProperty('displayName') ?: scriptName
        
        if (!scriptName) {
            throw new GradleException('è¯·æŒ‡å®šè„šæœ¬åç§°: -PscriptName=xxx')
        }
        
        def scriptsDir = file('src/main/java/me/mm/qs/scripts')
        def templateDir = new File(scriptsDir, 'example')
        def newScriptDir = new File(scriptsDir, scriptName)
        
        if (newScriptDir.exists()) {
            throw new GradleException("è„šæœ¬å·²å­˜åœ¨: ${scriptName}")
        }
        
        if (!templateDir.exists()) {
            throw new GradleException('æ¨¡æ¿è„šæœ¬(example)ä¸å­˜åœ¨')
        }
        
        // å¤åˆ¶æ¨¡æ¿ç›®å½•
        copy {
            from templateDir
            into newScriptDir
            // æ’é™¤æ¨¡æ¿çš„ .script-id æ–‡ä»¶
            exclude '.script-id'
        }
        
        // ç”Ÿæˆç‹¬ç«‹çš„è„šæœ¬ ID (32ä½éšæœºhexå­—ç¬¦ä¸²)
        def generateScriptId = {
            def seed = scriptName + "|" + displayName + "|" + System.currentTimeMillis() + "|" + UUID.randomUUID().toString()
            def md = java.security.MessageDigest.getInstance("MD5")
            def hash = md.digest(seed.getBytes("UTF-8"))
            def hexString = new StringBuilder()
            hash.each { b ->
                def hex = Integer.toHexString(0xff & b)
                if (hex.length() == 1) {
                    hexString.append('0')
                }
                hexString.append(hex)
            }
            return hexString.toString()
        }
        
        def scriptId = generateScriptId()
        def scriptIdFile = new File(newScriptDir, '.script-id')
        scriptIdFile.text = scriptId
        
        // æ›´æ–°åŒ…åå’Œè„šæœ¬ä¿¡æ¯
        def mainFile = new File(newScriptDir, 'Main.java')
        if (mainFile.exists()) {
            def content = mainFile.text
            content = content.replace('me.mm.qs.scripts.example', "me.mm.qs.scripts.${scriptName}")
            content = content.replace('name = "ç¤ºä¾‹è„šæœ¬"', "name = \"${displayName}\"")
            content = content.replace('è¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹è„šæœ¬æ¨¡æ¿', "è„šæœ¬: ${displayName}")
            mainFile.text = content
        }
        
        println "\nâœ¨ è„šæœ¬åˆ›å»ºæˆåŠŸ!"
        println "ğŸ“‚ ä½ç½®: ${newScriptDir.absolutePath}"
        println "ğŸ†” è„šæœ¬ID: ${scriptId}"
        println "\nä¸‹ä¸€æ­¥:"
        println "  1. ç¼–è¾‘ Main.java å®ç°ä½ çš„åŠŸèƒ½"
        println "  2. gradlew deployScript -PscriptName=${scriptName}"
    }
}

// ä»Androidè®¾å¤‡è·å–error.txtçš„ä»»åŠ¡
// ç”¨æ³•: gradlew fetchError -PscriptName=voice_converter [-PdeviceId=xxx]
task fetchError(type: Exec) {
    group = 'script'
    description = 'ä»Androidè®¾å¤‡è·å–error.txtç”¨äºåˆ†æ'
    
    doFirst {
        def deviceId = project.findProperty('deviceId')
        
        // è·å–è¦æŸ¥è¯¢çš„è„šæœ¬åç§°
        def getScriptName = {
            def scriptName = project.findProperty('scriptName')
            if (scriptName) {
                return scriptName
            }
            // å¦‚æœæ²¡æŒ‡å®šï¼ŒæŸ¥æ‰¾ dist ç›®å½•ä¸‹çš„è„šæœ¬
            def distDir = new File(project.projectDir, 'dist')
            def scriptDirs = distDir.listFiles({ File f -> f.isDirectory() && !f.name.startsWith('.') } as FileFilter)
            if (scriptDirs && scriptDirs.length > 0) {
                if (scriptDirs.length > 1) {
                    println "\nâš ï¸  å‘ç°å¤šä¸ªè„šæœ¬ï¼Œè¯·ä½¿ç”¨ -PscriptName=xxx æŒ‡å®š"
                    println "å¯ç”¨è„šæœ¬: ${scriptDirs*.name.join(', ')}"
                    throw new StopExecutionException()
                }
                return scriptDirs[0].name
            }
            throw new GradleException('åœ¨dist/ç›®å½•ä¸­æœªæ‰¾åˆ°è„šæœ¬æ–‡ä»¶å¤¹')
        }
        
        // è·å–è®¾å¤‡åˆ—è¡¨
        def getDevices = {
            def adbCheck = new ByteArrayOutputStream()
            project.exec {
                commandLine 'adb', 'devices'
                standardOutput = adbCheck
                errorOutput = new ByteArrayOutputStream()
                ignoreExitValue = true
            }
            
            def devicesList = adbCheck.toString().trim()
            def devices = []
            devicesList.split('\n').each { line ->
                if (line.contains('device') && !line.startsWith('List')) {
                    devices << line.split('\\s+')[0]
                }
            }
            return devices
        }
        
        def devices = getDevices()
        if (devices.isEmpty()) {
            println "\nâš ï¸  æœªæ£€æµ‹åˆ°Androidè®¾å¤‡!"
            throw new StopExecutionException()
        }
        
        if (devices.size() > 1 && !deviceId) {
            println "\nâš ï¸  å‘ç°å¤šä¸ªè®¾å¤‡ï¼Œè¯·ä½¿ç”¨ -PdeviceId=xxx æŒ‡å®š"
            println "å¯ç”¨è®¾å¤‡: ${devices.join(', ')}"
            throw new StopExecutionException()
        }
        
        def targetDevice = deviceId ?: devices[0]
        
        def scriptName = getScriptName()
        def sourcePath = "/storage/emulated/0/Android/data/com.tencent.mobileqq/QStory/Plugin/${scriptName}/error.txt"
        def targetFile = new File(project.projectDir, 'error.txt')
        
        println "\nğŸ“¥ æ­£åœ¨è·å–error.txt"
        println "è„šæœ¬: ${scriptName}"
        println "è®¾å¤‡: ${targetDevice}"
        
        def pullExec = project.exec {
            commandLine 'adb', '-s', targetDevice, 'pull', sourcePath, targetFile.absolutePath
            standardOutput = new ByteArrayOutputStream()
            errorOutput = new ByteArrayOutputStream()
            ignoreExitValue = true
        }
        
        if (pullExec.exitValue == 0) {
            println "âœ… é”™è¯¯æ–‡ä»¶è·å–æˆåŠŸ!"
            println "ğŸ“‚ ä¿å­˜åˆ°: ${targetFile.absolutePath}"
            
            if (targetFile.exists() && targetFile.length() > 0) {
                println "\nğŸ“„ é”™è¯¯æ–‡ä»¶å†…å®¹:"
                println "=" * 60
                println targetFile.text
                println "=" * 60
            } else {
                println "\nâœ“ æœªå‘ç°é”™è¯¯(æ–‡ä»¶ä¸ºç©º)"
            }
        } else {
            println "\nâš ï¸  è®¾å¤‡ä¸Šæœªæ‰¾åˆ°é”™è¯¯æ–‡ä»¶(è„šæœ¬å¯èƒ½æ²¡æœ‰é”™è¯¯)"
        }
    }
    
    commandLine 'cmd', '/c', 'echo.'
}