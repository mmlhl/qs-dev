# QStory BeanShell 脚本开发项目概览

## 项目目的
为 QStory BeanShell 脚本开发提供完整的 IDE 代码提示支持。解决在 IDEA 中编写 BeanShell 脚本时缺少类型提示的问题。

## 核心原理
1. **开发阶段**: 在 Java 环境中编写代码，使用具体类型（如 `MessageData`）享受完整的 IDE 提示
2. **转换阶段**: 通过 JavaParser 将 Java 代码转换为 BeanShell 格式，自动替换类型为 `Object`
3. **运行阶段**: 生成的 `dist/main.java` 可直接在 QStory 中作为 BeanShell 脚本使用

## 关键组件

### 1. 类型定义 (`src/main/java/me/mm/qs/script/types/`)
- `MessageData.java` - 消息数据结构（含所有字段：MessageContent, UserUin, GroupUin, IsGroup 等）
- `GroupInfo.java` - 群组信息（GroupUin, GroupName, AdminList 等）
- `GroupMemberInfo.java` - 群成员信息
- `ForbiddenInfo.java` - 禁言信息
- `FriendInfo.java` - 好友信息

所有类型标记 `@BeanShellType`，转换时自动变为 `Object`。

### 2. 注解系统 (`src/main/java/me/mm/qs/script/annotation/`)
- `@BeanShellType` - 标记类型，转换时替换为 Object
- `@ScriptMethods` - 标记类，其方法会被提取到 BeanShell 根级别
- `@RootCode` - 标记方法，仅提取方法体到根级别（用于初始化代码）

### 3. 基类 (`QScriptBase.java`)
定义所有 QStory 全局变量和 API 方法：
- 全局变量：`myUin`, `context`, `appPath`, `loader`, `pluginID`
- 回调方法：`onMsg()`, `onCreateMenu()`, `onForbiddenEvent()` 等
- API 方法：`sendMsg()`, `toast()`, `getGroupList()` 等
- 现已使用具体类型（如 `MessageData`）而非 `Object`

### 4. 转换器 (`scripts/JavaToBeanShellConverter.java`)
使用 JavaParser 实现以下转换：
- 识别 `@ScriptMethods` 注解的类
- 提取其中的方法到根级别
- 替换所有 `@BeanShellType` 类型为 `Object`
- 处理泛型（`ArrayList<MessageData>` → `ArrayList<Object>`）
- 移除所有注解
- 对 `@RootCode` 方法仅提取方法体
- 输出到 `dist/main.java`

## 工作流程

1. **编写脚本** - 在 `MyScript.java` 中编写：
```java
@ScriptMethods
public class MyScript extends QScriptBase {
    @Override
    public void onMsg(MessageData msg) {
        // 完整的 IDE 提示
        String text = msg.MessageContent;
    }
}

@ScriptMethods
class Init extends QScriptBase {
    @RootCode
    public void init() {
        addItem("菜单", "callback");
    }
}
```

2. **编译转换** - 运行 `gradlew.bat compileJava`：
   - 编译 Java 代码
   - 自动运行 `JavaToBeanShellConverter`
   - 生成 `dist/main.java`

3. **使用脚本** - 将 `dist/main.java` 复制到 QStory 脚本目录

## 转换示例

**输入 (MyScript.java)**:
```java
@Override
public void onMsg(MessageData msg) {
    toast(msg.MessageContent);
}
```

**输出 (dist/main.java)**:
```java
public void onMsg(Object msg) {
    toast(msg.MessageContent);
}
```

## Gradle 配置
- `compileJava.finalizedBy convertScript` - 编译后自动转换
- `convertScript` 任务调用 `JavaToBeanShellConverter` 处理 `MyScript.java`

## 关键设计决策

1. **类型映射**: 通过 `BEANSHELL_TYPES` Set 维护需转换的类型列表
2. **方法提取**: 使用 JavaParser AST 遍历类和方法
3. **注解检测**: 通过注解名称判断处理方式
4. **输出目录**: 固定输出到 `dist/main.java`（BeanShell 标准入口）

## API 来源
所有 API 定义基于 `src/api.md` 中的 QStory 官方文档。

## 技术栈
- Java 17+
- Gradle
- JavaParser 3.25.0
- Android SDK (android.jar 用于 Context 等类型)

## 注意事项
1. 不要直接编辑 `dist/main.java`，它会被自动覆盖
2. 所有开发在 `MyScript.java` 中进行
3. 新增类型需同时更新 `JavaToBeanShellConverter.BEANSHELL_TYPES`
